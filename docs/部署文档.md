# 部署文档

## 一、服务器要求

### 最低配置
- CPU：4核
- 内存：8GB
- 硬盘：100GB SSD
- 带宽：5Mbps
- 操作系统：Ubuntu 20.04 / CentOS 7+

### 推荐配置
- CPU：8核
- 内存：16GB
- 硬盘：500GB SSD
- 带宽：10Mbps
- 操作系统：Ubuntu 22.04

## 二、环境准备

### 1. 安装Node.js

```bash
# 使用nvm安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
node -v  # 验证安装
```

### 2. 安装PostgreSQL

```bash
# Ubuntu
sudo apt update
sudo apt install postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE hmachine;
CREATE USER hmachine_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE hmachine TO hmachine_user;
\q
```

### 3. 安装Redis

```bash
# Ubuntu
sudo apt install redis-server

# 启动服务
sudo systemctl start redis
sudo systemctl enable redis

# 验证
redis-cli ping  # 应返回PONG
```

### 4. 安装MinIO（可选）

```bash
# 下载
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
sudo mv minio /usr/local/bin/

# 创建数据目录
sudo mkdir -p /data/minio

# 启动（使用systemd）
sudo tee /etc/systemd/system/minio.service > /dev/null <<EOF
[Unit]
Description=MinIO
After=network.target

[Service]
Type=simple
User=root
Environment="MINIO_ROOT_USER=minioadmin"
Environment="MINIO_ROOT_PASSWORD=minioadmin"
ExecStart=/usr/local/bin/minio server /data/minio --console-address ":9001"
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl start minio
sudo systemctl enable minio
```

### 5. 安装Nginx

```bash
# Ubuntu
sudo apt install nginx

# 启动服务
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 6. 安装PM2

```bash
npm install -g pm2
```

## 三、项目部署

### 1. 克隆代码

```bash
cd /var/www
git clone https://github.com/jihongxing/HMachineMessage.git
cd HMachineMessage
```

### 2. 安装依赖

```bash
npm install
cd backend && npm install
cd ../frontend && npm install
cd ../shared && npm install
cd ..
```

### 3. 配置环境变量

**后端配置** (`backend/.env`)：
```env
# 数据库
DATABASE_URL="postgresql://hmachine_user:your_password@localhost:5432/hmachine"

# JWT密钥（生成随机字符串）
JWT_SECRET="your-random-secret-key-here"

# Redis
REDIS_HOST="localhost"
REDIS_PORT=6379
REDIS_PASSWORD=""

# MinIO
MINIO_ENDPOINT="localhost"
MINIO_PORT=9000
MINIO_ACCESS_KEY="minioadmin"
MINIO_SECRET_KEY="minioadmin"
MINIO_BUCKET="hmachine"
MINIO_USE_SSL=false

# 服务端口
PORT=3001
NODE_ENV=production

# 短信服务（根据实际服务商配置）
SMS_ACCESS_KEY=""
SMS_SECRET_KEY=""
SMS_SIGN_NAME=""
SMS_TEMPLATE_CODE=""

# 地图服务（高德地图）
AMAP_KEY=""
```

**前端配置** (`frontend/.env.production`)：
```env
NEXT_PUBLIC_API_URL=https://api.yourdomain.com
NEXT_PUBLIC_SITE_URL=https://yourdomain.com
```

### 4. 初始化数据库

```bash
cd backend
npx prisma migrate deploy
npx prisma generate
npm run seed:all
cd ..
```

### 5. 构建项目

```bash
# 构建后端
cd backend
npm run build

# 构建前端
cd ../frontend
npm run build

# 构建shared
cd ../shared
npm run build
```

### 6. 启动服务

使用PM2管理进程：

```bash
# 启动后端
cd backend
pm2 start dist/index.js --name hmachine-backend

# 启动前端
cd ../frontend
pm2 start npm --name hmachine-frontend -- start

# 保存PM2配置
pm2 save
pm2 startup
```

### 7. 配置Nginx

创建配置文件 `/etc/nginx/sites-available/hmachine`：

```nginx
# 后端API
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# 前端应用
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/hmachine /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 8. 配置SSL证书

使用Let's Encrypt免费证书：

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
sudo certbot --nginx -d api.yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

## 四、Docker部署

### 1. 安装Docker

```bash
# Ubuntu
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装docker-compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 配置环境变量

创建 `.env` 文件：
```env
# 数据库
POSTGRES_USER=hmachine_user
POSTGRES_PASSWORD=your_password
POSTGRES_DB=hmachine

# Redis
REDIS_PASSWORD=your_redis_password

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin

# 应用
JWT_SECRET=your-jwt-secret
NODE_ENV=production
```

### 3. 启动服务

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

### 4. 初始化数据库

```bash
# 进入后端容器
docker-compose exec backend sh

# 运行迁移
npx prisma migrate deploy
npm run seed:all

# 退出容器
exit
```

## 五、监控和日志

### 1. PM2监控

```bash
# 查看进程状态
pm2 status

# 查看日志
pm2 logs hmachine-backend
pm2 logs hmachine-frontend

# 查看详细信息
pm2 show hmachine-backend

# 重启服务
pm2 restart hmachine-backend
pm2 restart hmachine-frontend
```

### 2. 系统监控

```bash
# 安装htop
sudo apt install htop

# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 3. 日志管理

后端日志位置：
- PM2日志：`~/.pm2/logs/`
- 应用日志：`backend/logs/`

前端日志位置：
- PM2日志：`~/.pm2/logs/`

查看日志：
```bash
# 实时查看
tail -f ~/.pm2/logs/hmachine-backend-out.log
tail -f ~/.pm2/logs/hmachine-backend-error.log

# 查看最近100行
tail -n 100 backend/logs/app.log
```

## 六、备份策略

### 1. 数据库备份

创建备份脚本 `/root/backup-db.sh`：
```bash
#!/bin/bash
BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U hmachine_user -h localhost hmachine > $BACKUP_DIR/hmachine_$DATE.sql

# 压缩
gzip $BACKUP_DIR/hmachine_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: hmachine_$DATE.sql.gz"
```

设置定时任务：
```bash
chmod +x /root/backup-db.sh

# 添加到crontab（每天凌晨2点备份）
crontab -e
0 2 * * * /root/backup-db.sh
```

### 2. 文件备份

```bash
# 备份上传的文件
rsync -avz /data/minio/ /backup/minio/

# 备份代码
tar -czf /backup/code/hmachine_$(date +%Y%m%d).tar.gz /var/www/HMachineMessage
```

### 3. 恢复数据库

```bash
# 解压备份
gunzip /backup/postgres/hmachine_20240101_020000.sql.gz

# 恢复数据库
psql -U hmachine_user -h localhost hmachine < /backup/postgres/hmachine_20240101_020000.sql
```

## 七、性能优化

### 1. PostgreSQL优化

编辑 `/etc/postgresql/14/main/postgresql.conf`：
```conf
# 内存配置
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
work_mem = 64MB

# 连接配置
max_connections = 200

# 查询优化
random_page_cost = 1.1
effective_io_concurrency = 200
```

重启PostgreSQL：
```bash
sudo systemctl restart postgresql
```

### 2. Redis优化

编辑 `/etc/redis/redis.conf`：
```conf
# 内存限制
maxmemory 2gb
maxmemory-policy allkeys-lru

# 持久化
save 900 1
save 300 10
save 60 10000
```

重启Redis：
```bash
sudo systemctl restart redis
```

### 3. Nginx优化

编辑 `/etc/nginx/nginx.conf`：
```nginx
worker_processes auto;
worker_connections 4096;

# 开启gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

# 缓存配置
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;
```

## 八、安全加固

### 1. 防火墙配置

```bash
# 安装ufw
sudo apt install ufw

# 允许SSH
sudo ufw allow 22/tcp

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable
```

### 2. 限制数据库访问

编辑 `/etc/postgresql/14/main/pg_hba.conf`：
```conf
# 只允许本地访问
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
```

### 3. 定期更新

```bash
# 更新系统
sudo apt update
sudo apt upgrade

# 更新Node.js依赖
cd /var/www/HMachineMessage
npm audit fix
```

## 九、故障排查

### 常见问题

**1. 数据库连接失败**
```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 检查连接
psql -U hmachine_user -h localhost -d hmachine

# 查看日志
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

**2. Redis连接失败**
```bash
# 检查Redis状态
sudo systemctl status redis

# 测试连接
redis-cli ping

# 查看日志
sudo tail -f /var/log/redis/redis-server.log
```

**3. 应用无法启动**
```bash
# 查看PM2日志
pm2 logs hmachine-backend --lines 100

# 检查端口占用
sudo netstat -tlnp | grep 3001

# 重启服务
pm2 restart hmachine-backend
```

**4. Nginx配置错误**
```bash
# 测试配置
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

## 十、更新部署

### 1. 拉取最新代码

```bash
cd /var/www/HMachineMessage
git pull origin main
```

### 2. 更新依赖

```bash
npm install
cd backend && npm install
cd ../frontend && npm install
```

### 3. 运行数据库迁移

```bash
cd backend
npx prisma migrate deploy
```

### 4. 重新构建

```bash
cd backend && npm run build
cd ../frontend && npm run build
```

### 5. 重启服务

```bash
pm2 restart hmachine-backend
pm2 restart hmachine-frontend
```

## 十一、联系支持

如遇到部署问题，请：
1. 查看日志文件
2. 检查环境配置
3. 提交Issue：https://github.com/jihongxing/HMachineMessage/issues
