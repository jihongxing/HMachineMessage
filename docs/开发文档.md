# 开发文档

## 一、开发环境搭建

### 1. 前置要求

- Node.js >= 18.0.0
- npm >= 9.0.0
- PostgreSQL >= 14
- Redis >= 6
- Git

### 2. 克隆项目

```bash
git clone https://github.com/jihongxing/HMachineMessage.git
cd HMachineMessage
```

### 3. 安装依赖

```bash
# 安装根目录依赖
npm install

# 安装各模块依赖
npm run install:all
```

### 4. 配置环境变量

复制示例配置文件：
```bash
cp backend/.env.example backend/.env
cp frontend/.env.local.example frontend/.env.local
```

编辑配置文件，填入实际值。

### 5. 初始化数据库

```bash
cd backend
npx prisma migrate dev
npx prisma generate
npm run seed:all
```

### 6. 启动开发服务器

```bash
# 启动后端（终端1）
cd backend
npm run dev

# 启动前端（终端2）
cd frontend
npm run dev
```

访问：
- 前端：http://localhost:3000
- 后端API：http://localhost:3001

## 二、项目结构详解

### Backend结构

```
backend/
├── src/
│   ├── config/              # 配置文件
│   │   └── index.ts         # 统一配置导出
│   ├── controllers/         # 控制器层
│   │   ├── auth.controller.ts
│   │   ├── equipment.controller.ts
│   │   └── ...
│   ├── middleware/          # 中间件
│   │   ├── auth.ts          # 认证中间件
│   │   ├── rateLimit.ts     # 限流中间件
│   │   ├── validate.ts      # 验证中间件
│   │   └── errorHandler.ts  # 错误处理
│   ├── routes/              # 路由定义
│   │   ├── auth.routes.ts
│   │   ├── equipment.routes.ts
│   │   └── index.ts
│   ├── services/            # 业务逻辑层
│   │   ├── auth.service.ts
│   │   ├── equipment.service.ts
│   │   ├── cache.ts         # 缓存服务
│   │   ├── prisma.ts        # 数据库客户端
│   │   └── storage/         # 存储服务
│   │       ├── provider.ts
│   │       └── minio.ts
│   ├── utils/               # 工具函数
│   │   ├── jwt.ts
│   │   ├── password.ts
│   │   ├── logger.ts
│   │   └── errors.ts
│   └── index.ts             # 入口文件
├── prisma/
│   ├── schema.prisma        # 数据库模型
│   ├── migrations/          # 数据库迁移
│   └── seeds/               # 种子数据
└── package.json
```

### Frontend结构

```
frontend/
├── src/
│   ├── app/                 # Next.js App Router
│   │   ├── layout.tsx       # 根布局
│   │   ├── page.tsx         # 首页
│   │   ├── auth/            # 认证页面
│   │   ├── equipment/       # 设备页面
│   │   ├── orders/          # 订单页面
│   │   ├── profile/         # 个人中心
│   │   └── admin/           # 管理后台
│   ├── components/          # React组件
│   │   ├── ui/              # UI组件
│   │   │   ├── Modal.tsx
│   │   │   ├── Loading.tsx
│   │   │   └── ...
│   │   ├── Navbar.tsx
│   │   ├── Breadcrumb.tsx
│   │   └── ...
│   ├── lib/                 # 工具库
│   │   ├── api/             # API客户端
│   │   │   ├── client.ts
│   │   │   ├── interceptors.ts
│   │   │   └── endpoints/
│   │   ├── store/           # 状态管理
│   │   │   ├── userStore.ts
│   │   │   ├── appStore.ts
│   │   │   └── index.ts
│   │   └── utils/           # 工具函数
│   │       ├── format.ts
│   │       ├── validate.ts
│   │       └── ...
│   └── styles/              # 样式文件
│       └── globals.css
└── package.json
```

### Shared结构

```
shared/
├── src/
│   └── types/               # 共享类型定义
│       ├── api.ts
│       ├── equipment.ts
│       ├── user.ts
│       └── index.ts
└── package.json
```

## 三、开发规范

### 1. 代码风格

使用ESLint和Prettier统一代码风格：

```bash
# 检查代码
npm run lint

# 自动修复
npm run lint:fix

# 格式化代码
npm run format
```

### 2. Git提交规范

使用Conventional Commits规范：

```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
perf: 性能优化
test: 测试相关
chore: 构建/工具链相关
```

示例：
```bash
git commit -m "feat: 添加设备二维码分享功能"
git commit -m "fix: 修复用户登录状态丢失问题"
```

### 3. 分支管理

- `main`：主分支，生产环境代码
- `develop`：开发分支
- `feature/*`：功能分支
- `fix/*`：修复分支
- `hotfix/*`：紧急修复分支

工作流程：
```bash
# 创建功能分支
git checkout -b feature/qrcode-share

# 开发完成后合并到develop
git checkout develop
git merge feature/qrcode-share

# 测试通过后合并到main
git checkout main
git merge develop
```

## 四、核心功能开发

### 1. 添加新的API接口

**步骤1：定义路由**

`backend/src/routes/example.routes.ts`：
```typescript
import { Router } from 'express';
import { exampleController } from '../controllers/example.controller';
import { authenticate } from '../middleware/auth';
import { validate } from '../middleware/validate';
import { exampleSchema } from '../schemas/example.schema';

const router = Router();

router.post(
  '/example',
  authenticate,
  validate(exampleSchema),
  exampleController.create
);

export default router;
```

**步骤2：实现控制器**

`backend/src/controllers/example.controller.ts`：
```typescript
import { Request, Response } from 'express';
import { exampleService } from '../services/example.service';
import { asyncHandler } from '../utils/asyncHandler';

export const exampleController = {
  create: asyncHandler(async (req: Request, res: Response) => {
    const data = await exampleService.create(req.body);
    res.json({
      code: 0,
      message: 'success',
      data
    });
  })
};
```

**步骤3：实现服务层**

`backend/src/services/example.service.ts`：
```typescript
import { prisma } from './prisma';

export const exampleService = {
  async create(data: any) {
    return await prisma.example.create({
      data
    });
  }
};
```

**步骤4：注册路由**

`backend/src/routes/index.ts`：
```typescript
import exampleRoutes from './example.routes';

app.use('/api/example', exampleRoutes);
```

### 2. 添加新的前端页面

**步骤1：创建页面**

`frontend/src/app/example/page.tsx`：
```typescript
'use client';

import { useState, useEffect } from 'react';
import { exampleApi } from '@/lib/api';

export default function ExamplePage() {
  const [data, setData] = useState([]);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const res = await exampleApi.getList();
    setData(res.data);
  };

  return (
    <div className="container py-6">
      <h1>Example Page</h1>
      {/* 页面内容 */}
    </div>
  );
}
```

**步骤2：添加API客户端**

`frontend/src/lib/api/endpoints/example.ts`：
```typescript
import apiClient from '../client';

export const exampleApi = {
  getList: () => apiClient.get('/example'),
  create: (data: any) => apiClient.post('/example', data),
  update: (id: string, data: any) => apiClient.put(`/example/${id}`, data),
  delete: (id: string) => apiClient.delete(`/example/${id}`)
};
```

**步骤3：导出API**

`frontend/src/lib/api/index.ts`：
```typescript
export { exampleApi } from './endpoints/example';
```

### 3. 添加数据库模型

**步骤1：编辑schema**

`backend/prisma/schema.prisma`：
```prisma
model Example {
  id        Int      @id @default(autoincrement())
  name      String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("examples")
}
```

**步骤2：创建迁移**

```bash
cd backend
npx prisma migrate dev --name add_example_table
```

**步骤3：生成客户端**

```bash
npx prisma generate
```

## 五、测试

### 1. 单元测试

使用Jest进行单元测试：

```bash
# 运行测试
npm test

# 查看覆盖率
npm run test:coverage
```

示例测试：
```typescript
// backend/src/services/__tests__/example.service.test.ts
import { exampleService } from '../example.service';

describe('ExampleService', () => {
  it('should create example', async () => {
    const data = { name: 'test', value: 'value' };
    const result = await exampleService.create(data);
    expect(result.name).toBe('test');
  });
});
```

### 2. API测试

使用Postman或curl测试API：

```bash
# 测试登录
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'

# 测试获取设备列表
curl http://localhost:3001/api/equipment \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. E2E测试

使用Playwright进行端到端测试：

```bash
# 安装Playwright
npm install -D @playwright/test

# 运行E2E测试
npm run test:e2e
```

## 六、调试技巧

### 1. 后端调试

使用VS Code调试：

`.vscode/launch.json`：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Backend",
      "runtimeExecutable": "npm",
      "runtimeArgs": ["run", "dev"],
      "cwd": "${workspaceFolder}/backend",
      "console": "integratedTerminal"
    }
  ]
}
```

### 2. 前端调试

使用浏览器开发者工具：
- Chrome DevTools
- React Developer Tools
- Redux DevTools

### 3. 数据库调试

使用Prisma Studio：
```bash
cd backend
npx prisma studio
```

访问：http://localhost:5555

## 七、性能优化

### 1. 后端优化

- 使用Redis缓存热点数据
- 数据库查询优化（索引、分页）
- 使用连接池
- 异步处理耗时操作

### 2. 前端优化

- 代码分割（动态导入）
- 图片懒加载
- 使用Next.js Image组件
- 减少不必要的重渲染

### 3. 数据库优化

- 添加索引
- 优化查询语句
- 使用数据库连接池
- 定期清理无用数据

## 八、常见问题

### 1. 数据库连接失败

检查：
- PostgreSQL是否启动
- 连接字符串是否正确
- 数据库用户权限

### 2. Redis连接失败

检查：
- Redis是否启动
- 连接配置是否正确
- 防火墙设置

### 3. 前端无法访问API

检查：
- 后端是否启动
- CORS配置是否正确
- API_URL环境变量

### 4. 图片上传失败

检查：
- MinIO是否启动
- 存储桶是否创建
- 权限配置是否正确

## 九、开发工具推荐

### IDE
- VS Code（推荐）
- WebStorm

### VS Code插件
- ESLint
- Prettier
- Prisma
- GitLens
- Thunder Client（API测试）

### 浏览器插件
- React Developer Tools
- Redux DevTools
- JSON Viewer

### 其他工具
- Postman（API测试）
- DBeaver（数据库管理）
- Redis Desktop Manager

## 十、参考资料

### 官方文档
- [Next.js](https://nextjs.org/docs)
- [React](https://react.dev/)
- [Prisma](https://www.prisma.io/docs)
- [Express](https://expressjs.com/)
- [TypeScript](https://www.typescriptlang.org/docs/)

### 学习资源
- [Next.js教程](https://nextjs.org/learn)
- [React教程](https://react.dev/learn)
- [TypeScript教程](https://www.typescriptlang.org/docs/handbook/intro.html)

## 十一、贡献指南

1. Fork项目
2. 创建功能分支
3. 提交代码
4. 推送到分支
5. 创建Pull Request

代码审查标准：
- 代码风格符合规范
- 通过所有测试
- 添加必要的注释
- 更新相关文档

## 十二、联系方式

- 项目地址：https://github.com/jihongxing/HMachineMessage
- 问题反馈：https://github.com/jihongxing/HMachineMessage/issues
- 开发讨论：[待定]
